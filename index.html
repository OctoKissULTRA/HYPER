<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYPERtrends v4.1 - Neural Trading Matrix</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cyber-bg: #0a0a0a;
            --cyber-surface: #111111;
            --cyber-card: #1a1a1a;
            --cyber-cyan: #00ffff;
            --cyber-purple: #ff00ff;
            --cyber-blue: #0066ff;
            --cyber-green: #00ff41;
            --cyber-red: #ff073a;
            --cyber-orange: #ff6b00;
            --cyber-yellow: #ffff00;
            --cyber-text: #e0e0e0;
            --cyber-text-dim: #888888;
            --cyber-border: #333333;
            --cyber-gradient-primary: linear-gradient(135deg, #00ffff 0%, #0066ff 50%, #ff00ff 100%);
            --cyber-gradient-danger: linear-gradient(135deg, #ff073a 0%, #ff6b00 100%);
            --cyber-gradient-success: linear-gradient(135deg, #00ff41 0% , #00ffff 100%);
            --cyber-glow-cyan: 0 0 20px rgba(0, 255, 255, 0.5);
            --cyber-shadow: 0 8px 32px rgba(0,0,0,0.8);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            background: var(--cyber-bg);
            color: var(--cyber-text);
            font-family: 'Rajdhani', monospace;
            overflow-x: hidden;
            min-height: 100vh;
        }
        .cyber-grid {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(0,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridPulse 4s ease-in-out infinite;
            z-index: -1;
        }
        @keyframes gridPulse { 0%,100%{opacity:0.3;} 50%{opacity:0.1;} }
        .header {
            background: rgba(17,17,17,0.95);
            border-bottom: 2px solid var(--cyber-cyan);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--cyber-shadow);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }
        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 900;
            background: var(--cyber-gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: var(--cyber-glow-cyan);
            animation: logoGlow 2s ease-in-out infinite alternate;
        }
        @keyframes logoGlow {
            from { filter: drop-shadow(0 0 5px var(--cyber-cyan)); }
            to { filter: drop-shadow(0 0 15px var(--cyber-cyan)); }
        }
        .status-bar {
            display: flex; gap: 2rem; align-items: center;
        }
        .status-item { display:flex; align-items:center; gap:0.5rem; font-size:0.9rem; font-weight:500;}
        .status-dot {
            width: 8px; height:8px; border-radius:50%; background: var(--cyber-green);
            box-shadow: var(--cyber-glow-cyan); animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1; transform:scale(1);} 50%{opacity:0.7;transform:scale(1.2);} }
        .container {
            max-width: 1600px; margin:0 auto; padding:2rem;
            display:grid; grid-template-columns:300px 1fr 350px;
            gap:2rem; min-height:calc(100vh - 120px);
        }
        .control-panel {
            grid-row: 1 / -1;
            background: rgba(26,26,26,0.9);
            border:1px solid var(--cyber-border);
            border-radius:12px;
            padding:1.5rem;
            box-shadow: var(--cyber-shadow);
        }
        .panel-title {
            font-family:'Orbitron',monospace;
            font-size:1.2rem;font-weight:700;color:var(--cyber-cyan);
            margin-bottom:1.5rem;text-align:center;text-transform:uppercase;letter-spacing:1px;
        }
        .symbol-grid { display: grid; grid-template-columns:1fr 1fr; gap:0.5rem; margin-bottom:2rem;}
        .symbol-btn {
            background: var(--cyber-card); border:1px solid var(--cyber-border);
            color:var(--cyber-text); padding:0.75rem; border-radius:8px;
            font-family:'Orbitron',monospace; font-weight:600; cursor:pointer;
            transition: all 0.3s ease; text-align:center;
        }
        .symbol-btn:hover { border-color:var(--cyber-cyan); box-shadow:var(--cyber-glow-cyan); transform:translateY(-2px);}
        .symbol-btn.active { background:var(--cyber-gradient-primary); color:var(--cyber-bg); box-shadow:var(--cyber-glow-cyan);}
        .time-intervals {display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:2rem;}
        .time-btn {
            background:var(--cyber-surface); border:1px solid var(--cyber-border); color:var(--cyber-text);
            padding:0.5rem 1rem; border-radius:6px; font-size:0.8rem; cursor:pointer;
            transition:all 0.3s ease; flex:1; text-align:center;
        }
        .time-btn:hover { border-color:var(--cyber-blue); box-shadow:0 0 10px rgba(0,102,255,0.3);}
        .time-btn.active { background:var(--cyber-blue); color:white; box-shadow:var(--cyber-glow-cyan);}
        .chart-area {
            background:rgba(26,26,26,0.9);
            border:1px solid var(--cyber-border);
            border-radius:12px; padding:1.5rem; box-shadow:var(--cyber-shadow);
        }
        .chart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;}
        .chart-title { font-family:'Orbitron',monospace; font-size:1.5rem; font-weight:700; color:var(--cyber-cyan);}
        .price-display { text-align:right; }
        .current-price { font-family:'Orbitron',monospace; font-size:2rem; font-weight:700; color:var(--cyber-green);}
        .price-change { font-size:1rem; font-weight:600;}
        .price-up { color:var(--cyber-green);}
        .price-down { color:var(--cyber-red);}
        .chart-container { position:relative; height:400px; margin-bottom:1rem;}
        /* Responsive omitted for brevity: matches previous */
        @media (max-width: 1200px) { .container { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .container { padding: 1rem; gap: 1rem;} .logo{font-size:1.5rem;} }
    </style>
</head>
<body>
    <div class="cyber-grid"></div>
    <header class="header">
        <div class="header-content">
            <div class="logo">⚡ HYPERTRENDS</div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="live-dot"></div>
                    <span id="connection-status">NEURAL LINK ACTIVE</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" style="background: var(--cyber-purple);"></div>
                    <span id="data-source">ALPACA MATRIX</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" style="background: var(--cyber-blue);"></div>
                    <span id="components-count">5 MODULES</span>
                </div>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="control-panel">
            <h3 class="panel-title">⚡ NEURAL CONTROL</h3>
            <div class="symbol-grid">
                <button class="symbol-btn active" data-symbol="QQQ">QQQ</button>
                <button class="symbol-btn" data-symbol="SPY">SPY</button>
                <button class="symbol-btn" data-symbol="NVDA">NVDA</button>
                <button class="symbol-btn" data-symbol="AAPL">AAPL</button>
                <button class="symbol-btn" data-symbol="MSFT">MSFT</button>
            </div>
            <h4 style="color: var(--cyber-cyan); margin-bottom: 0.5rem; font-size: 0.9rem;">⏱ TIME MATRIX</h4>
            <div class="time-intervals">
                <button class="time-btn" data-interval="1m">1M</button>
                <button class="time-btn" data-interval="5m">5M</button>
                <button class="time-btn" data-interval="15m">15M</button>
                <button class="time-btn active" data-interval="1h">1H</button>
                <button class="time-btn" data-interval="4h">4H</button>
                <button class="time-btn" data-interval="1d">1D</button>
            </div>
        </div>
        <div class="chart-area">
            <div class="chart-header">
                <div>
                    <h2 class="chart-title" id="chart-symbol">QQQ</h2>
                    <div style="font-size: 0.8rem; color: var(--cyber-text-dim);">INVESCO QQQ TRUST</div>
                </div>
                <div class="price-display">
                    <div class="current-price" id="current-price">$0.00</div>
                    <div class="price-change price-up" id="price-change">+0.00 (0.00%)</div>
                </div>
            </div>
            <div style="margin-bottom: 1em;">
                <span id="market-status" style="font-family: 'Orbitron'; font-weight: 700; padding: 0.4em 1em; border-radius: 8px; background: #222; color: #00ffff;">Loading...</span>
            </div>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
    <script>
        let priceChart = null;
        let currentSymbol = 'QQQ';
        let currentInterval = '1h';

        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            bindEventListeners();
            fetchAndRenderHistory();
            updateMarketStatus();
        });

        function bindEventListeners() {
            document.querySelectorAll('.symbol-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const symbol = this.dataset.symbol;
                    currentSymbol = symbol;
                    selectSymbolUI(symbol);
                    fetchAndRenderHistory();
                    updateMarketStatus();
                });
            });
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const interval = this.dataset.interval;
                    currentInterval = interval;
                    selectIntervalUI(interval);
                    fetchAndRenderHistory();
                });
            });
        }

        function selectSymbolUI(symbol) {
            document.querySelectorAll('.symbol-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-symbol="${symbol}"]`).classList.add('active');
            document.getElementById('chart-symbol').textContent = symbol;
        }
        function selectIntervalUI(interval) {
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-interval="${interval}"]`).classList.add('active');
        }

        async function fetchAndRenderHistory() {
            try {
                const response = await fetch(`/api/history?symbol=${currentSymbol}&interval=${currentInterval}&limit=50`);
                const result = await response.json();
                renderChartWithHistory(result.data);
                updateMarketStatus(result.data_status);
            } catch (e) {
                updateMarketStatus("ERROR");
            }
        }

        function renderChartWithHistory(bars) {
            if (!bars || bars.length === 0) return;
            const labels = bars.map(b => new Date(b.t));
            const data = bars.map(b => b.c);
            priceChart.data.labels = labels;
            priceChart.data.datasets[0].data = data;
            priceChart.update();
            // Update price/price-change
            const last = bars[bars.length - 1];
            const prev = bars.length > 1 ? bars[bars.length - 2] : last;
            document.getElementById('current-price').textContent = `$${parseFloat(last.c).toFixed(2)}`;
            const change = last.c - prev.c;
            const changePct = prev.c !== 0 ? ((change / prev.c) * 100).toFixed(2) : "0.00";
            const changeEl = document.getElementById('price-change');
            changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct}%)`;
            changeEl.className = `price-change ${change >= 0 ? 'price-up' : 'price-down'}`;
        }

        async function updateMarketStatus(status) {
            let stat = status;
            if (!status) {
                // Get from ping
                try {
                    const resp = await fetch('/api/ping');
                    const data = await resp.json();
                    stat = data.data_status;
                } catch { stat = "ERROR"; }
            }
            const el = document.getElementById('market-status');
            if (!el) return;
            if (stat === "LIVE") {
                el.textContent = "LIVE";
                el.style.background = "#003322";
                el.style.color = "#00ff41";
            } else if (stat === "STALE") {
                el.textContent = "STALE (MARKET CLOSED)";
                el.style.background = "#221111";
                el.style.color = "#ff073a";
            } else {
                el.textContent = "ERROR";
                el.style.background = "#222";
                el.style.color = "#ff073a";
            }
        }

        function initializeChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: '#00ffff',
                        backgroundColor: 'rgba(0,255,255,0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#00ffff',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                            grid: { color: 'rgba(0,255,255,0.1)' },
                            ticks: { color: '#888', font: { family: 'Rajdhani' } }
                        },
                        y: {
                            grid: { color: 'rgba(0,255,255,0.1)' },
                            ticks: { color: '#888', font: { family: 'Rajdhani' } }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' },
                    animation: { duration: 750, easing: 'easeInOutQuart' }
                }
            });
        }
    </script>
</body>
</html>
